#!/bin/bash

token=$1
repo=$2
update_command=$3
update_path='./test/rust'
username=$4
organization=$5

branch_name="automated-dependencies-update-"
email="noreply@github.com"

if [ -z "$token" ]; then
    echo "token is not defined"
    exit 1
fi

if [ -z "$organization" ]; then
    echo "organization is not defined, defaulting to $username"
    organization=username
fi

# if [ -n "$PATH" ]; then
#      cd './test/rust' #TODO: Use from parameter
# fi

echo "Switched to $update_path"
cd './test/rust'

# assumes the repo is already cloned as a prerequisite for running the script

# fetch first to be able to detect if branch already exists 
git fetch

# branch already exists, previous opened PR was not merged
if [ -n "git branch --list $branch_name" ]
then
    echo "Branch name $branch_name already exists"

    echo "Check out branch instead" 
    # check out existing branch
    git checkout $branch_name

    git pull

    # reset with latest from main
    git reset --hard origin/main
else
    git checkout -b $branch_name
fi

echo "Running update command $update_command"
eval $update_command

if [ -n "git diff" ]
then
    echo "Updates detected"

    # configure git authorship
    git config --global user.email $email
    git config --global user.name $username

    # format: https://[username]:[token]@github.com/[organization]/[repo].git
    git remote add authenticated "https://$username:$token@github.com/$organization/$repo.git"

    # commit the changes to Cargo.lock
    git commit -a -m "Auto-update cargo crates"
    
    # push the changes
    git push authenticated $branch_name

    echo "https://api.github.com/repos/$organization/$repo/pulls"

    # create the PR
    # if PR already exists, then update
    response=$(curl --write-out "%{message}\n" -X POST -H "Content-Type: application/json" -H "Authorization: token $token" \
         --data '{"title":"Autoupdate dependencies","head": "'"$branch_name"'","base":"main", "body":"Auto-generated pull request. \nThis pull request is generated by GitHub action based on the provided update commands."}' \
         "https://api.github.com/repos/$organization/$repo/pulls")
    
    echo $response   
    
    if [[ "$response" == *"already exist"* ]]; then
        echo "Pull request already opened. Updates were pushed to the existing PR instead"
        exit 0
    fi
else
    echo "No dependencies updates were detected"
    exit 0
fi
